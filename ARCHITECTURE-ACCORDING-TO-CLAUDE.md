# Pushwork Architecture

> This document was generated by Claude from reading the source code.

Pushwork is a CLI tool for bidirectional file synchronization using **Automerge CRDTs**. It maps a local filesystem directory tree to a mirror tree of Automerge documents and syncs them through a WebSocket relay server. Multiple peers can edit the same files and changes merge automatically.

## Module Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                        CLI (cli.ts)                         │
│              Commander.js argument parsing                   │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                    Commands (commands.ts)                     │
│  setupCommandContext() → creates Repo + SyncEngine           │
│  sync(), commit(), status(), diff(), clone(), init(), ...    │
└────────────────────────┬────────────────────────────────────┘
                         │
          ┌──────────────┼──────────────┐
          ▼              ▼              ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────────────┐
│  ConfigMgr   │ │  RepoFactory │ │      SyncEngine      │
│ (config.ts)  │ │(repo-factory)│ │  (sync-engine.ts)    │
│              │ │              │ │                      │
│ defaults <   │ │ Automerge    │ │  Orchestrates the    │
│ global <     │ │ Repo with    │ │  entire sync cycle   │
│ local        │ │ storage +    │ │                      │
└──────────────┘ │ WebSocket    │ │  ┌────────────────┐  │
                 └──────────────┘ │  │ChangeDetector  │  │
                                  │  │ FS vs snapshot  │  │
                                  │  │ vs remote docs  │  │
                                  │  └────────────────┘  │
                                  │  ┌────────────────┐  │
                                  │  │ MoveDetector   │  │
                                  │  │ content-sim    │  │
                                  │  │ rename detect  │  │
                                  │  └────────────────┘  │
                                  │  ┌────────────────┐  │
                                  │  │SnapshotManager │  │
                                  │  │ .pushwork/     │  │
                                  │  │ snapshot.json  │  │
                                  │  └────────────────┘  │
                                  └──────────┬───────────┘
                                             │
                    ┌────────────────────────┼────────────────────┐
                    ▼                        ▼                    ▼
          ┌─────────────────┐   ┌──────────────────┐   ┌─────────────────┐
          │   text-diff.ts  │   │ network-sync.ts  │   │  directory.ts   │
          │                 │   │                  │   │                 │
          │ spliceText()    │   │ waitForSync()    │   │ getPlainUrl()   │
          │ updateText      │   │ waitForBidi      │   │ getVersioned    │
          │ Content()       │   │ directionalSync()│   │ Url()           │
          │ readDocContent()│   │ batch size: 10   │   │ findFileIn      │
          └─────────────────┘   └────────┬─────────┘   │ Directory()     │
                                         │             └─────────────────┘
                                         ▼
                              ┌──────────────────────┐
                              │   Automerge Relay     │
                              │  (WebSocket server)   │
                              │  sync3.automerge.org  │
                              └──────────────────────┘
```

## Source Layout

```
src/
  cli.ts                  — Commander.js entry point; registers all commands
  commands.ts             — Command implementations; shared setupCommandContext()
  index.ts                — Library export entry point

  core/
    sync-engine.ts        — Two-phase sync coordinator (the heart of the system)
    change-detection.ts   — ChangeDetector: local + remote diff engine
    move-detection.ts     — MoveDetector: content-similarity-based rename detection
    snapshot.ts           — SnapshotManager: reads/writes .pushwork/snapshot.json
    config.ts             — ConfigManager: loads/merges defaults < global < local

  utils/
    repo-factory.ts       — Creates the Automerge Repo with storage + network adapters
    network-sync.ts       — waitForSync(), waitForBidirectionalSync()
    text-diff.ts          — spliceText(), updateTextContent(), readDocContent()
    content.ts            — contentHash(), isContentEqual()
    directory.ts          — getPlainUrl(), findFileInDirectoryHierarchy()
    fs.ts                 — readFileContent(), writeFileContent(), listDirectory()
    mime-types.ts         — isEnhancedTextFile(), getEnhancedMimeType()
    string-similarity.ts  — Sørensen-Dice coefficient for move detection
    output.ts             — Output singleton (ora spinner + chalk colors)
    trace.ts              — Debug tracing helpers

  types/
    documents.ts          — FileDocument, DirectoryDocument, DirectoryEntry
    snapshot.ts           — SyncSnapshot, SnapshotFileEntry, SyncResult
    config.ts             — DirectoryConfig, GlobalConfig, CLI option interfaces
```

## Data Model

Every node in the synced tree is an Automerge document:

- **FileDocument** — A file. Content is either collaborative text (mutable CRDT string supporting character-level `splice`) or raw bytes (for binary files). Also stores name, extension, mimeType, and permissions metadata.
- **DirectoryDocument** — A directory. Contains a `docs` array of `{name, type, url}` entries pointing to child documents. Forms a tree rooted at one directory document.
- **DirectoryEntry** — A single `{name, type, url}` reference inside a directory's `docs` array. For artifact files, the URL includes Automerge heads (a versioned snapshot); for regular files, it's a plain mutable URL.

```
DirectoryDocument (root)
├── docs: [
│   { name: "readme.md",   type: "file",   url: "automerge:abc123" }
│   { name: "src",          type: "folder", url: "automerge:def456" }
│   { name: "config.json",  type: "file",   url: "automerge:ghi789" }
│ ]
│
└── DirectoryDocument (src/)
    └── docs: [
        { name: "index.ts", type: "file", url: "automerge:jkl012" }
      ]
```

## How the Layers Connect

### CLI → Commands

`cli.ts` registers Commander.js commands and calls exported functions from `commands.ts`. The CLI layer is thin — it only handles argument parsing, option validation, and process exits. It doesn't touch Automerge directly.

### Commands → Core

`commands.ts` provides the shared setup function `setupCommandContext()`, which:

1. Verifies the `.pushwork/` directory exists
2. Loads and merges config (defaults < global `~/.pushwork/config.json` < local `.pushwork/config.json`)
3. Creates an Automerge `Repo` via `createRepo()` — sets up `NodeFSStorageAdapter` for local persistence and optionally a `BrowserWebSocketClientAdapter` for network sync
4. Instantiates a `SyncEngine` with the repo, working directory, and config

Every command (sync, commit, status, diff, ls, etc.) calls `setupCommandContext()`, uses the `SyncEngine`, then calls `safeRepoShutdown()`.

### SyncEngine — The Coordinator

`SyncEngine` owns the entire sync cycle and holds references to three subsystems:

- **ChangeDetector** — compares local filesystem state against the snapshot and remote Automerge documents to classify every file as local-only, remote-only, both-changed, or unchanged
- **MoveDetector** — pairs local-only deletions with local-only creations using content similarity (Sørensen-Dice coefficient) to detect renames
- **SnapshotManager** — reads and writes `.pushwork/snapshot.json`, which records the last-known state of every tracked file and directory

## The Sync Cycle

When you run `pushwork sync`, the following happens:

```
1. NETWORK WAIT
   Wait for any incoming remote changes to arrive
   (bidirectional sync poll until heads stabilize)
         │
         ▼
2. DETECT CHANGES + MOVES
   Compare local filesystem, snapshot heads, and
   remote document heads to classify every file.
   Pair deletions with creations to detect renames.
         │
         ▼
3. PUSH (local → remote)
   Process directories deepest-first:
     new files    → repo.create() a new Automerge doc
     modified     → handle.changeAt(heads) + spliceText()
     deleted      → remove entry from parent directory doc
     moved        → rename entry in parent directory doc
         │
         ▼
4. NETWORK UPLOAD
   waitForSync() — push docs to relay in batches of 10
   waitForBidirectionalSync() — poll until heads stabilize
         │
         ▼
5. RE-DETECT CHANGES
   Fresh change detection pass; filter to remote-only
   and both-changed files
         │
         ▼
6. PULL (remote → local)
   Write remote changes to the local filesystem
   Process shallowest paths first (parents before children)
         │
         ▼
7. UPDATE SNAPSHOT
   Re-read all document heads, save snapshot.json
```

### The Snapshot as 3-Way Baseline

The snapshot's `head` (Automerge document heads) for each file acts as the common ancestor in a 3-way comparison:

- **Local filesystem content** vs **content at snapshot head** = local changes
- **Current Automerge document** vs **snapshot head** = remote changes
- Both changed → `BOTH_CHANGED` (the CRDT handles merge automatically via `changeAt`)

## Key Design Decisions

### Leaf-First Push Ordering

During the push phase, directories are sorted deepest-first. This guarantees that when a parent directory document is updated, all its children's Automerge documents are already finalized with their correct URLs. The parent then records the correct versioned URLs.

### `changeAt(heads)` for Merging

Edits branch from the snapshot's known heads using `handle.changeAt(heads, callback)`. This gives Automerge a proper common ancestor for conflict-free 3-way merge. Without this, concurrent edits from different peers would overwrite each other instead of merging.

### Orphaned Deletions

Deleting a file just removes it from its parent directory's `docs` array. The Automerge document itself is left as an orphan — clearing a large text CRDT would be O(n) in character operations, which is very slow for large files.

### Artifact Directories

Files in configured `artifact_directories` (default: `dist/`) are treated as immutable snapshots rather than collaboratively-edited text. They use `RawString` (not the text CRDT), are never diffed/spliced, and are always replaced with a new document on update. A SHA-256 `contentHash` in the snapshot detects local changes without reading the Automerge doc.

### Batched Network Sync

Documents sync to the relay server in batches of 10 (`SYNC_BATCH_SIZE`). The Automerge sync server is single-threaded with no backpressure, so sending 100+ documents simultaneously would overwhelm it.

### Immutable String Handling

Old Automerge documents may store text content as `RawString` (immutable) instead of the collaborative text CRDT. You can't `splice` into these. The codebase handles this with `updateTextContent()` which detects the type and either splices or assigns directly, and a nuclear path in `updateRemoteFile()` that recreates the entire document if needed.

## On-Disk Layout

```
your-project/
  .pushwork/
    config.json        ← local config overrides
    snapshot.json      ← change-detection baseline (paths, URLs, heads)
    automerge/         ← Automerge document binary storage

~/.pushwork/
  config.json          ← global user-level config
```

## Key Dependencies

| Package | Purpose |
|---|---|
| `@automerge/automerge` | Core CRDT engine: splice, changeAt, RawString |
| `@automerge/automerge-repo` | Repo, DocHandle, document lifecycle management |
| `@automerge/automerge-repo-network-websocket` | WebSocket transport to relay server |
| `@automerge/automerge-repo-storage-nodefs` | Local filesystem persistence for Automerge docs |
| `@commander-js/extra-typings` | CLI command framework |
| `diff` | Character-level diffing to feed `A.splice()` |
| `glob` | Recursive filesystem enumeration |
| `ignore` | Gitignore-style pattern matching for excludes |
